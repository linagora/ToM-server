services:
  traefik:
    image: traefik:v2.11
    restart: unless-stopped
    command:
      - "--api.insecure=true"
      - "--api.dashboard=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.file.directory=/etc/traefik/dynamic"
      - "--providers.file.watch=true"
      - "--entrypoints.web.address=:80"
      - "--log.level=INFO"
    ports:
      - "80:80"
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./.compose/traefik/dynamic:/etc/traefik/dynamic:ro
    extra_hosts:
      - "host.docker.internal:host-gateway"

  ldap:
    image: osixia/openldap:1.5.0
    environment:
      LDAP_ORGANISATION: "Docker"
      LDAP_DOMAIN: "docker.internal"
      LDAP_ADMIN_PASSWORD: "admin"
      LDAP_CONFIG_PASSWORD: "config"
      LDAP_READONLY_USER: "false"
      LDAP_RFC2307BIS_SCHEMA: "false"
      LDAP_BACKEND: "mdb"
      LDAP_TLS: "false"
      LDAP_LOG_LEVEL: "256"
      LDAP_REMOVE_CONFIG_AFTER_SETUP: "false"
      DISABLE_CHOWN: "true"
    ports:
      - "389:389"
    volumes:
      - ./.compose/ldap/bootstrap:/container/service/slapd/assets/config/bootstrap/ldif/custom
    healthcheck:
      test: ["CMD-SHELL", "ldapsearch -x -b 'dc=docker,dc=internal' -H ldap://localhost || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  smtp:
    image: changemakerstudiosus/papercut-smtp:latest
    ports:
      - "2525:25"

  synapse:
    image: matrixdotorg/synapse:v1.119.0
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      traefik:
        condition: service_started
    ports:
      - "8008:8008"
    volumes:
      - ./.compose/synapse/.data:/data
      - ./.compose/synapse/pgsql.yaml:/data/homeserver.yaml:ro
      - ./.compose/synapse/docker.internal.log.config:/data/docker.internal.log.config:ro
      - ./.compose/synapse/docker.internal.signing.key:/data/docker.internal.signing.key:ro
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.synapse.rule=Host(`matrix.docker.internal`)"
      - "traefik.http.routers.synapse.entrypoints=web"
      - "traefik.http.services.synapse.loadbalancer.server.port=8008"

  postgres:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_USER: twake
      POSTGRES_PASSWORD: twake_password
      POSTGRES_DB: postgres
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./.compose/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U twake"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

volumes:
  postgres-data:
