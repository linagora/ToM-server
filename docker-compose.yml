# File              : docker-compose.yml
# License           : AGPL-3.0-or-later
# Author            : Pierre 'McFly' Marty <pmarty@linagora.com>
# Date              : 16.01.2025
# Last Modified Date: 27.01.2025
# Last Modified By  : Pierre 'McFly' Marty <pmarty@linagora.com>

services:
  auth:
    image: yadd/lemonldap-ng-full
    volumes:
      - ./.compose/lemon/lmConf-1.json:/var/lib/lemonldap-ng/conf/lmConf-1.json
      - ./.compose/lemon/ssl.conf:/etc/nginx/sites-enabled/0000default.conf
      - ./.compose/lemon/root.conf:/etc/nginx/sites-enabled/root.conf
      - ./.compose/synapse/wellknownserver.conf:/var/www/matrix-server.json
      - ./.compose/synapse/wellknownclient.conf:/var/www/matrix-client.json
      - ./.compose/ssl:/etc/nginx/ssl
      - ./.compose/lemon/lemon.db:/db/lemon.db
    environment:
      - SSODOMAIN=docker.localhost
      - PORTAL=https://auth.docker.localhost
      - LOGLEVEL=debug
      - LOGGER=stderr
      - USERLOGGER=stderr
    deploy:
      mode: replicated
      replicas: 1
      restart_policy:
        condition: on-failure
    networks:
      frontend:
        aliases:
          - auth

  synapse:
    image: matrixdotorg/synapse
    restart: unless-stopped
    env_file:
      - path: .compose/.env
        required: true
    volumes:
      - ./.compose/synapse:/data
      - ./.compose/ssl:/etc/ssl/certs
    depends_on:
      auth:
        condition: service_started
    networks:
      frontend:
        aliases:
          - synapse

  tom:
    build:
      context: .
    volumes:
      # - ./.compose/tom:/opt/twake/db/
      - ./.compose/synapse:/opt/synapse/db/
    depends_on:
      synapse:
        condition: service_started
    ports:
      - 3000:3000
      - 9229:9229
    networks:
      frontend:
        aliases:
          - tom.server
    environment:
      - NODE_OPTIONS="--inspect=0.0.0.0:9229"
      - BASE_URL=https://tom.docker.localhost
      - DATABASE_ENGINE=sqlite
      # - DATABASE_HOST=/opt/twake/db/tom.db
      - DATABASE_HOST=file:tom?mode=memory&cache=shared
      - MATRIX_SERVER=matrix.docker.localhost
      - MATRIX_DATABASE_ENGINE=sqlite
      - MATRIX_DATABASE_HOST=/opt/synapse/db/homeserver.db
      - OIDC_ISSUER=https://auth.docker.localhost
      - SERVER_NAME=docker.localhost
      - USERDB_ENGINE=sqlite
      # - USERSB_HOST=/opt/twake/db/users.db
      - USERDB_HOST=file:users?mode=memory&cache=shared
      - LOG_LEVEL=debug
      - LOG_TRANSPORTS=Console
      - TEMPLATE_DIR=/usr/src/app/packages/tom-server/templates
      - TRUSTED_PROXIES=uniquelocal
      - ADDITIONAL_FEATURES=true
      - NODE_TLS_REJECT_UNAUTHORIZED=0
      - CRON_SERVICE=true

  # fed:
  #   build:
  #     context: .
  #   volumes:
  #     - ./.compose/fed:/opt/twake/db/
  #     - ./.compose/synapse:/opt/synapse/db/
  #   depends_on:
  #     synapse:
  #       condition: service_started
  #   ports:
  #     - 3000:3000
  #   networks:
  #     frontend:
  #       aliases:
  #         - fed.server
  #   environment:
  #     - BASE_URL=https://tom.docker.localhost
  #     - DATABASE_ENGINE=sqlite
  #     - DATABASE_HOST=/opt/twake/db/fed.db
  #     - MATRIX_SERVER=matrix.docker.localhost
  #     - SERVER_NAME=docker.localhost
  #     - USERDB_ENGINE=sqlite
  #     - LOG_LEVEL=silly
  #     - LOG_TRANSPORTS=Console
  #     - TRUSTED_PROXIES=uniquelocal
  #     - NODE_TLS_REJECT_UNAUTHORIZED=0

  chat:
    image: linagora/twake-web
    volumes:
      - ./.compose/chat/config.json:/usr/share/nginx/html/web/config.json
      - ./.compose/chat/default.conf.template:/etc/nginx/templates/default.conf.template
      - ./.compose/ssl:/etc/nginx/ssl
    ports:
      - 6868:6868
    environment:
      - TWAKECHAT_LISTEN_PORT=6868
    networks:
      - frontend

  haproxy:
    image: haproxy:2.6-bookworm
    ports:
      - 443:443
    volumes:
      - ./.compose/haproxy:/usr/local/etc/haproxy:ro
      - ./.compose/ssl/both.pem:/etc/ssl/certs/both.pem
    sysctls:
      - net.ipv4.ip_unprivileged_port_start=0
    depends_on:
      - auth
      - chat
      - synapse
      - tom
    networks:
      frontend:
        aliases:
          - auth.docker.localhost
          - chat.docker.localhost
          - matrix.docker.localhost
          - tom.docker.localhost
          - docker.localhost

networks:
  frontend:
    name: frontend
