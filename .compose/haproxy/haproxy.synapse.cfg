global
   lua-load /usr/local/etc/haproxy/cors.lua
   log stdout format raw local0 debug

defaults
    log global
    mode http
    option httplog clf
    option dontlognull
    retries 3
    option redispatch
    maxconn 2000

frontend http-in
   bind *:443 ssl crt /etc/ssl/certs/both.pem
   bind *:8448 ssl crt /etc/ssl/certs/both.pem
   http-request lua.cors "GET,PUT,POST,DELETE" "*" "*"
   http-response lua.cors

   acl is_matrix hdr_end(host) -i matrix.docker.localhost
   acl is_synapse_matrix path_beg -i /_matrix
   acl is_synapse_synapse path_beg -i /_synapse
   acl is_well-known path_beg -i /.well-known/matrix

   use_backend matrix if is_matrix

   acl is_portal hdr_end(host) -i auth.docker.localhost
   acl is_portal hdr_end(host) -i docker.localhost
   use_backend portal if is_portal

backend portal
   balance roundrobin
   option forwardfor
   http-request set-header X-Forwarded-Proto https
   server node1 auth:80 check
   server node2 auth:80 check
   server node3 auth:80 check

backend matrix
   balance roundrobin
   option forwardfor
   http-request set-header X-Forwarded-Proto https
   server synapse_main synapse:8008 check
